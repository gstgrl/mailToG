<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>QR Code</title>
        <!-- Bootstrap 5 CDN -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    </head>
    <body class="bg-dark text-light min-vh-100 d-flex justify-content-center align-items-center">
        <div class="container text-center">
            <h1>{{title}}</h1>

            <div class="mt-2 mb-5">
                <a class="btn btn-primary" href="/{{redirect}}">Torna indietro</a>
            </div>

            {% for qrcode in data %}
                <div class="card m-2 mx-auto bg-dark-subtle" style="width: 22rem;">

                    <div class="card-header d-flex flex-row justify-content-between">
                        <span class="badge align-self-center {{ badge.get(qrcode.status, 'bg-dark').class }} p-2 mx-2">
                            {{ badge.get(qrcode.status, 'Non attivo').label }}
                        </span>

                        
                        {% if private %}
                            <h6>-> {{qrcode.receiver | get_name}}</h6> 
                        {% endif %}
                       
                        <button type="button" class="btn-close align-self-center" id="qr-close-button-{{ qrcode.id }}" onclick="hideQR('{{ qrcode.id }}')" style="display: none;"></button>
                    </div>

                    <div class="card-body d-flex flex-row justify-content-center align-items-center">
                        <div class="d-flex flex-column">
                            <button type="button" class="btn btn-light mx-2" id="qr-button-{{ qrcode.id }}" onclick="generateQR('{{ qrcode.id }}')">Visualizza QrCode</button>
                            <div id="qr-container-{{ qrcode.id }}"></div>
                        </div>
                    </div>

                    <div class="card-footer">
                        {% if badge[qrcode.status].time %}
                            {{ badge[qrcode.status]['time']['label'] }} {{ qrcode[badge[qrcode.status]['time']['column']] | format_datetime }}
                        {% endif %}

                        {% if badge[qrcode.status].function %}
                            <button class="btn btn-sm btn-outline-primary align-self-center"
                                    onclick="{{ badge[qrcode.status].function }}({{ qrcode.id }})">
                                Attiva QR Code
                            </button>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <script> 
            function generateQR(id) {
                const btn = document.getElementById(`qr-button-${id}`);
                const closeBtn = document.getElementById(`qr-close-button-${id}`);
                const qrContainer = document.getElementById(`qr-container-${id}`);

                fetch(`/qrManager/generate_qr/${id}`)
                .then(response => response.json())
                .then(data => {
                    btn.style.display = "none";
                    closeBtn.style.display = "block";
                    qrContainer.innerHTML = `<img src="data:image/png;base64,${data.qr}" alt="QR Code" class="img-thumbnail mt-3" style="height: 100px;"/>`;
                })
                .catch(err => console.error("Errore:", err));
            }

            function hideQR(id) {
                const btn = document.getElementById(`qr-button-${id}`);
                const closeBtn = document.getElementById(`qr-close-button-${id}`);
                const qrContainer = document.getElementById(`qr-container-${id}`);

                btn.style.display = "block";
                closeBtn.style.display = "none";
                qrContainer.innerHTML = "";
            }

            async function activateQRCode(id) {
                try {
                    const response = await fetch(`/status/modify/${id}`);

                    const data = await response.json();

                    if (data.success) {
                        console.log("Stato aggiornato con successo");
                    } else {
                        console.error("Errore: aggiornamento fallito");
                    }
                } catch (error) {
                    console.error("Errore di rete o di parsing:", error);
                }
            }
        </script>
    </body>
</html>
